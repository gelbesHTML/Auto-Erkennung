<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Teachable Machine – Image Classifier</title>

  <!-- Browser builds; defer guarantees they load before our code runs -->
  <script defer src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@3.21.0/dist/tf.min.js"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/@teachablemachine/image@0.8.4/dist/teachablemachine-image.min.js"></script>

  <style>
    :root { --w: 900px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; padding:24px; }
    .wrap { max-width: var(--w); margin: 0 auto; text-align: center; }
    h1 { margin: 8px 0 6px; }
    .row { display:flex; gap:10px; align-items:center; justify-content:center; flex-wrap: wrap; }
    .url { max-width:560px; width:100%; padding:10px 12px; border:1px solid #ddd; border-radius:10px; }
    button, input[type="file"] { font-size:1rem; padding:10px 14px; border:1px solid #ddd; border-radius:10px; background:#fafafa; }
    button:disabled, input[type="file"]:disabled { opacity:.6; cursor:not-allowed; }
    #status { color:#555; margin: 10px 0 16px; }
    #preview { max-width: 360px; display:none; border-radius:12px; margin: 16px auto; }
    #result { font-size: 1.2rem; font-weight: 600; margin-top: 12px; }
    .list { max-width:560px; margin: 12px auto; text-align: left; }
    .item { display:grid; grid-template-columns: 140px 1fr 60px; gap:10px; align-items:center; margin:8px 0; }
    .bar { height:10px; background:#eee; border-radius:6px; overflow:hidden; }
    .fill { height:100%; background:#4a90e2; width:0; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Teachable Machine – Image Classifier</h1>
    <p>Paste your <b>Teachable Machine model URL</b> (should look like
      <code>https://teachablemachine.withgoogle.com/models/ID/</code>), click <b>Load model</b>, then upload an image.</p>

    <div class="row" style="margin-bottom:10px">
      <input id="modelUrl" class="url" placeholder="https://teachablemachine.withgoogle.com/models/YOUR_ID/" />
      <button id="loadBtn">Load model</button>
      <button id="clearBtn" title="Forget saved URL">Clear</button>
    </div>

    <div id="status">No model loaded.</div>

    <input id="upload" type="file" accept="image/*" disabled />
    <img id="preview" alt="Preview" />

    <div id="result"></div>
    <div id="details" class="list"></div>
  </div>

  <script>
    let model, ready = false;

    function validModelUrl(u){
      // relaxed but safe check
      return typeof u === "string"
        && u.startsWith("https://teachablemachine.withgoogle.com/models/")
        && u.endsWith("/");
    }

    async function loadModel(baseUrl) {
      const status = document.getElementById("status");
      const btn = document.getElementById("loadBtn");
      const upload = document.getElementById("upload");

      if (!validModelUrl(baseUrl)) {
        status.textContent = "Please paste the FULL model URL (must be from teachablemachine.withgoogle.com and end with /).";
        return;
      }

      status.textContent = "Loading model…";
      btn.disabled = true;
      upload.disabled = true;

      try {
        if (typeof tmImage === "undefined") {
          throw new Error("Teachable Machine library (tmImage) not loaded.");
        }
        const modelURL = baseUrl + "model.json";
        const metadataURL = baseUrl + "metadata.json";
        model = await tmImage.load(modelURL, metadataURL);
        ready = true;
        status.textContent = "Model loaded. Choose an image.";
        upload.disabled = false;
        try { localStorage.setItem("tm_model_url", baseUrl); } catch {}
      } catch (err) {
        console.error(err);
        status.textContent = "Failed to load model. Check the URL and your network.";
        btn.disabled = false;
      }
    }

    function wireUp(){
      const status = document.getElementById("status");
      const urlInput = document.getElementById("modelUrl");
      const loadBtn = document.getElementById("loadBtn");
      const clearBtn = document.getElementById("clearBtn");
      const upload = document.getElementById("upload");
      const img = document.getElementById("preview");
      const result = document.getElementById("result");
      const details = document.getElementById("details");

      // restore last URL
      try {
        const saved = localStorage.getItem("tm_model_url");
        if (saved) urlInput.value = saved;
      } catch {}

      loadBtn.addEventListener("click", () => loadModel(urlInput.value));
      urlInput.addEventListener("keydown", (e) => { if (e.key === "Enter") loadModel(urlInput.value); });
      clearBtn.addEventListener("click", () => {
        try { localStorage.removeItem("tm_model_url"); } catch {}
        urlInput.value = "";
        status.textContent = "Cleared. Paste your model URL again.";
      });

      upload.addEventListener("change", async (ev) => {
        if (!ready) return;
        const file = ev.target.files?.[0];
        if (!file) return;

        img.src = window.URL.createObjectURL(file);
        img.style.display = "block";
        status.textContent = "Running inference…";
        result.textContent = "";
        details.innerHTML = "";

        await new Promise((res, rej) => { img.onload = res; img.onerror = rej; });

        try {
          const preds = await model.predict(img);
          preds.sort((a,b) => b.probability - a.probability);
          const top = preds[0];
          result.textContent = `Prediction: ${top.className} (${(top.probability*100).toFixed(1)}%)`;
          status.textContent = "Done.";

          const show = preds.slice(0, Math.min(5, preds.length));
          details.innerHTML = show.map(p => {
            const pct = Math.round(p.probability * 100);
            return `<div class="item">
              <div>${p.className}</div>
              <div class="bar"><div class="fill" style="width:${pct}%"></div></div>
              <div>${pct}%</div>
            </div>`;
          }).join("");
        } catch (e) {
          console.error(e);
          status.textContent = "Error during prediction.";
        }
      });

      // helpful message if libs didn’t load
      if (typeof tmImage === "undefined") {
        status.textContent = "Loading libraries… (If this never changes, your network may block jsDelivr; try another connection.)";
      }
    }

    // Run after DOM is ready and after deferred scripts are parsed
    window.addEventListener("DOMContentLoaded", wireUp);
  </script>
</body>
</html>
